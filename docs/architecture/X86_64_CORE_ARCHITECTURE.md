# Helix OS Framework - x86_64 Core Architecture

## Design Document v1.0

**Date**: 2026-01-29
**Author**: Helix Architecture Team
**Status**: Implementation Ready

---

## ðŸŽ¯ Executive Summary

This document defines the complete x86_64 core architecture for Helix OS Framework.
This implementation aims to support **millions of lines** of kernel code while
remaining modular, maintainable, and performant.

### Key Objectives

| Objective | Description | Metric |
|-----------|-------------|--------|
| **Scalability** | Massive kernel support | 100k+ lines HAL x86_64 |
| **Modularity** | Independent components | 30+ modules |
| **Performance** | Minimal latency | < 1Âµs context switch |
| **SMP-Ready** | Multi-core from the design | 256+ CPUs |
| **Extensibility** | Easy feature addition | Plugin architecture |

---

## ðŸ“ Directory Structure

```
hal/src/arch/x86_64/
â”œâ”€â”€ mod.rs                          # Main entry point
â”œâ”€â”€ README.md                       # Module documentation
â”‚
â”œâ”€â”€ core/                           # CPU fundamentals (5,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ cpuid.rs                    # CPUID enumeration & features
â”‚   â”œâ”€â”€ msr.rs                      # Complete MSR framework
â”‚   â”œâ”€â”€ control_regs.rs             # CR0-CR4, XCR0
â”‚   â”œâ”€â”€ features.rs                 # CPU feature detection
â”‚   â”œâ”€â”€ cache.rs                    # Cache management
â”‚   â””â”€â”€ fpu.rs                      # FPU/SSE/AVX state
â”‚
â”œâ”€â”€ segmentation/                   # GDT/TSS/LDT (3,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ gdt.rs                      # GDT management
â”‚   â”œâ”€â”€ tss.rs                      # TSS per-CPU
â”‚   â”œâ”€â”€ selectors.rs                # Segment selectors
â”‚   â””â”€â”€ descriptors.rs              # Descriptor types
â”‚
â”œâ”€â”€ interrupts/                     # IDT/Exceptions/IRQ (8,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ idt.rs                      # IDT management
â”‚   â”œâ”€â”€ exceptions.rs               # Exception handlers
â”‚   â”œâ”€â”€ handlers.rs                 # Handler generation
â”‚   â”œâ”€â”€ stubs.rs                    # ASM stubs
â”‚   â”œâ”€â”€ ist.rs                      # Interrupt Stack Table
â”‚   â”œâ”€â”€ irq_routing.rs              # IRQ routing table
â”‚   â””â”€â”€ nmi.rs                      # NMI handling
â”‚
â”œâ”€â”€ apic/                           # APIC/IOAPIC (6,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ local_apic.rs               # Local APIC (xAPIC)
â”‚   â”œâ”€â”€ x2apic.rs                   # x2APIC mode
â”‚   â”œâ”€â”€ ioapic.rs                   # I/O APIC
â”‚   â”œâ”€â”€ msi.rs                      # MSI/MSI-X support
â”‚   â”œâ”€â”€ ipi.rs                      # Inter-Processor Interrupts
â”‚   â””â”€â”€ vectors.rs                  # Vector allocation
â”‚
â”œâ”€â”€ paging/                         # MMU/Paging (10,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ level4.rs                   # 4-level paging
â”‚   â”œâ”€â”€ level5.rs                   # 5-level (LA57)
â”‚   â”œâ”€â”€ page_table.rs               # Page table abstraction
â”‚   â”œâ”€â”€ entries.rs                  # Page table entries
â”‚   â”œâ”€â”€ flags.rs                    # Page flags
â”‚   â”œâ”€â”€ tlb.rs                      # TLB management
â”‚   â”œâ”€â”€ huge_pages.rs               # 2MB/1GB pages
â”‚   â”œâ”€â”€ mapper.rs                   # Page mapper
â”‚   â”œâ”€â”€ walker.rs                   # Page table walker
â”‚   â”œâ”€â”€ frame_allocator.rs          # Frame allocation interface
â”‚   â””â”€â”€ kaslr.rs                    # KASLR integration
â”‚
â”œâ”€â”€ timers/                         # Timing subsystem (4,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ tsc.rs                      # TSC (invariant)
â”‚   â”œâ”€â”€ hpet.rs                     # High Precision Event Timer
â”‚   â”œâ”€â”€ apic_timer.rs               # Local APIC timer
â”‚   â”œâ”€â”€ pit.rs                      # Legacy PIT (calibration)
â”‚   â”œâ”€â”€ calibration.rs              # Timer calibration
â”‚   â””â”€â”€ time_api.rs                 # Unified time API
â”‚
â”œâ”€â”€ smp/                            # Multi-processor (5,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ ap_boot.rs                  # AP startup sequence
â”‚   â”œâ”€â”€ trampoline.rs               # Real-mode trampoline
â”‚   â”œâ”€â”€ per_cpu.rs                  # Per-CPU data
â”‚   â”œâ”€â”€ barriers.rs                 # Memory barriers
â”‚   â”œâ”€â”€ spinlock.rs                 # Spinlocks
â”‚   â””â”€â”€ topology.rs                 # CPU topology
â”‚
â”œâ”€â”€ syscall/                        # System calls (2,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ entry.rs                    # SYSCALL/SYSRET
â”‚   â”œâ”€â”€ compat.rs                   # 32-bit compatibility
â”‚   â””â”€â”€ table.rs                    # Syscall table
â”‚
â”œâ”€â”€ context/                        # Context switching (3,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ switch.rs                   # Context switch
â”‚   â”œâ”€â”€ state.rs                    # CPU state
â”‚   â”œâ”€â”€ fpu_context.rs              # FPU/SIMD state
â”‚   â””â”€â”€ extended.rs                 # Extended state (XSAVE)
â”‚
â”œâ”€â”€ debug/                          # Debug facilities (2,000+ lines)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ breakpoints.rs              # Hardware breakpoints (DR0-DR7)
â”‚   â”œâ”€â”€ trace.rs                    # Tracing support
â”‚   â””â”€â”€ dump.rs                     # State dumping
â”‚
â”œâ”€â”€ asm/                            # Assembly code (2,000+ lines)
â”‚   â”œâ”€â”€ boot.S                      # Boot code
â”‚   â”œâ”€â”€ entry.S                     # Entry points
â”‚   â”œâ”€â”€ switch.S                    # Context switch
â”‚   â”œâ”€â”€ trampoline.S                # SMP trampoline
â”‚   â””â”€â”€ handlers.S                  # Interrupt stubs
â”‚
â””â”€â”€ tests/                          # Unit tests
    â”œâ”€â”€ mod.rs
    â”œâ”€â”€ cpuid_tests.rs
    â”œâ”€â”€ msr_tests.rs
    â”œâ”€â”€ paging_tests.rs
    â””â”€â”€ apic_tests.rs
```

**Total estimate: 50,000+ lines of pure Rust for the x86_64 HAL**

---

## ðŸ—ï¸ Detailed Architecture

### 1. Core CPU Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CPU CORE FRAMEWORK                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   CPUID      â”‚  â”‚    MSRs      â”‚  â”‚  Control     â”‚  â”‚   Features   â”‚ â”‚
â”‚  â”‚  Enumeration â”‚  â”‚  Framework   â”‚  â”‚  Registers   â”‚  â”‚  Detection   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ Vendor ID  â”‚  â”‚ â€¢ EFER       â”‚  â”‚ â€¢ CR0        â”‚  â”‚ â€¢ SSE        â”‚ â”‚
â”‚  â”‚ â€¢ Family     â”‚  â”‚ â€¢ STAR       â”‚  â”‚ â€¢ CR2        â”‚  â”‚ â€¢ AVX        â”‚ â”‚
â”‚  â”‚ â€¢ Model      â”‚  â”‚ â€¢ LSTAR      â”‚  â”‚ â€¢ CR3        â”‚  â”‚ â€¢ AVX-512    â”‚ â”‚
â”‚  â”‚ â€¢ Stepping   â”‚  â”‚ â€¢ CSTAR      â”‚  â”‚ â€¢ CR4        â”‚  â”‚ â€¢ RDRAND     â”‚ â”‚
â”‚  â”‚ â€¢ Cache      â”‚  â”‚ â€¢ SFMASK     â”‚  â”‚ â€¢ XCR0       â”‚  â”‚ â€¢ RDSEED     â”‚ â”‚
â”‚  â”‚ â€¢ Features   â”‚  â”‚ â€¢ FS_BASE    â”‚  â”‚ â€¢ CR8        â”‚  â”‚ â€¢ SMAP       â”‚ â”‚
â”‚  â”‚ â€¢ Topology   â”‚  â”‚ â€¢ GS_BASE    â”‚  â”‚              â”‚  â”‚ â€¢ SMEP       â”‚ â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ KERNEL_GS  â”‚  â”‚              â”‚  â”‚ â€¢ UMIP       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### MSR Framework

```rust
/// MSR namespace with type-safe accessors
pub mod msr {
    // Extended Feature Enable Register
    pub const IA32_EFER: u32 = 0xC000_0080;
    pub const IA32_STAR: u32 = 0xC000_0081;
    pub const IA32_LSTAR: u32 = 0xC000_0082;
    pub const IA32_CSTAR: u32 = 0xC000_0083;
    pub const IA32_SFMASK: u32 = 0xC000_0084;
    pub const IA32_FS_BASE: u32 = 0xC000_0100;
    pub const IA32_GS_BASE: u32 = 0xC000_0101;
    pub const IA32_KERNEL_GS_BASE: u32 = 0xC000_0102;
    pub const IA32_TSC_AUX: u32 = 0xC000_0103;

    // APIC
    pub const IA32_APIC_BASE: u32 = 0x1B;
    pub const IA32_X2APIC_APICID: u32 = 0x802;

    // Time
    pub const IA32_TSC: u32 = 0x10;
    pub const IA32_TSC_ADJUST: u32 = 0x3B;

    // MTRR
    pub const IA32_MTRR_CAP: u32 = 0xFE;
    pub const IA32_MTRR_DEF_TYPE: u32 = 0x2FF;

    // PAT
    pub const IA32_PAT: u32 = 0x277;

    // Power
    pub const IA32_MISC_ENABLE: u32 = 0x1A0;
    pub const IA32_PERF_CTL: u32 = 0x199;
}
```

### 2. Segmentation Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SEGMENTATION FRAMEWORK                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  GDT Layout (Per-CPU for SMP):                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Index  â”‚ Segment                                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 0x00   â”‚ Null Descriptor (required)                              â”‚   â”‚
â”‚  â”‚ 0x08   â”‚ Kernel Code 64-bit (CS)                                 â”‚   â”‚
â”‚  â”‚ 0x10   â”‚ Kernel Data (DS, SS, ES, FS, GS)                        â”‚   â”‚
â”‚  â”‚ 0x18   â”‚ User Data 64-bit (for SYSRET order)                     â”‚   â”‚
â”‚  â”‚ 0x20   â”‚ User Code 64-bit                                        â”‚   â”‚
â”‚  â”‚ 0x28   â”‚ User Code 32-bit (compat mode)                          â”‚   â”‚
â”‚  â”‚ 0x30   â”‚ TSS Low (16 bytes total)                                â”‚   â”‚
â”‚  â”‚ 0x38   â”‚ TSS High                                                â”‚   â”‚
â”‚  â”‚ 0x40+  â”‚ Per-CPU extended segments                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  TSS Per-CPU (104 bytes each):                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ RSP0: Kernel stack for ring 0                                       â”‚â”‚
â”‚  â”‚ RSP1: (unused in modern OS)                                         â”‚â”‚
â”‚  â”‚ RSP2: (unused in modern OS)                                         â”‚â”‚
â”‚  â”‚ IST1: Double Fault stack (16KB)                                     â”‚â”‚
â”‚  â”‚ IST2: Page Fault stack (16KB)                                       â”‚â”‚
â”‚  â”‚ IST3: NMI stack (8KB)                                               â”‚â”‚
â”‚  â”‚ IST4: Machine Check stack (8KB)                                     â”‚â”‚
â”‚  â”‚ IST5: Debug stack (8KB)                                             â”‚â”‚
â”‚  â”‚ IST6: Breakpoint stack (8KB)                                        â”‚â”‚
â”‚  â”‚ IST7: General exception stack (8KB)                                 â”‚â”‚
â”‚  â”‚ IOPB: I/O Permission Bitmap offset                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Interrupt Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INTERRUPT FRAMEWORK                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Vector Allocation (256 vectors):                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 0x00-0x1F  â”‚ CPU Exceptions (reserved by Intel)                    â”‚  â”‚
â”‚  â”‚            â”‚ 0x00: #DE Divide Error                                â”‚  â”‚
â”‚  â”‚            â”‚ 0x01: #DB Debug                                       â”‚  â”‚
â”‚  â”‚            â”‚ 0x02: NMI                                             â”‚  â”‚
â”‚  â”‚            â”‚ 0x03: #BP Breakpoint                                  â”‚  â”‚
â”‚  â”‚            â”‚ 0x04: #OF Overflow                                    â”‚  â”‚
â”‚  â”‚            â”‚ 0x05: #BR Bound Range                                 â”‚  â”‚
â”‚  â”‚            â”‚ 0x06: #UD Invalid Opcode                              â”‚  â”‚
â”‚  â”‚            â”‚ 0x07: #NM Device Not Available                        â”‚  â”‚
â”‚  â”‚            â”‚ 0x08: #DF Double Fault (IST1)                         â”‚  â”‚
â”‚  â”‚            â”‚ 0x09: (legacy) Coprocessor Segment                    â”‚  â”‚
â”‚  â”‚            â”‚ 0x0A: #TS Invalid TSS                                 â”‚  â”‚
â”‚  â”‚            â”‚ 0x0B: #NP Segment Not Present                         â”‚  â”‚
â”‚  â”‚            â”‚ 0x0C: #SS Stack Fault                                 â”‚  â”‚
â”‚  â”‚            â”‚ 0x0D: #GP General Protection                          â”‚  â”‚
â”‚  â”‚            â”‚ 0x0E: #PF Page Fault (IST2)                           â”‚  â”‚
â”‚  â”‚            â”‚ 0x10: #MF x87 FP Exception                            â”‚  â”‚
â”‚  â”‚            â”‚ 0x11: #AC Alignment Check                             â”‚  â”‚
â”‚  â”‚            â”‚ 0x12: #MC Machine Check (IST3)                        â”‚  â”‚
â”‚  â”‚            â”‚ 0x13: #XM SIMD Exception                              â”‚  â”‚
â”‚  â”‚            â”‚ 0x14: #VE Virtualization                              â”‚  â”‚
â”‚  â”‚            â”‚ 0x15: #CP Control Protection                          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 0x20-0x2F  â”‚ Legacy PIC IRQs (remapped)                            â”‚  â”‚
â”‚  â”‚            â”‚ 0x20: Timer (IRQ0)                                    â”‚  â”‚
â”‚  â”‚            â”‚ 0x21: Keyboard (IRQ1)                                 â”‚  â”‚
â”‚  â”‚            â”‚ 0x22: Cascade (IRQ2)                                  â”‚  â”‚
â”‚  â”‚            â”‚ 0x23-0x2F: Other IRQs                                 â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 0x30-0x7F  â”‚ IOAPIC IRQs (80 vectors)                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 0x80       â”‚ Syscall (legacy int 0x80)                             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 0x81-0xEF  â”‚ MSI/MSI-X vectors (111 vectors)                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 0xF0-0xFD  â”‚ IPI vectors                                           â”‚  â”‚
â”‚  â”‚            â”‚ 0xF0: Reschedule IPI                                  â”‚  â”‚
â”‚  â”‚            â”‚ 0xF1: TLB Shootdown IPI                               â”‚  â”‚
â”‚  â”‚            â”‚ 0xF2: Call Function IPI                               â”‚  â”‚
â”‚  â”‚            â”‚ 0xF3: Call Function Single IPI                        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 0xFE       â”‚ APIC Error                                            â”‚  â”‚
â”‚  â”‚ 0xFF       â”‚ Spurious Interrupt                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  Handler Generation (Macro-based):                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ exception_handler!(divide_error, 0x00, false, |frame| {...})        â”‚â”‚
â”‚  â”‚ exception_handler!(page_fault, 0x0E, true, |frame, code| {...})     â”‚â”‚
â”‚  â”‚ irq_handler!(timer, 0x20, |frame| {...})                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Paging Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PAGING FRAMEWORK                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  4-Level Paging (Standard):                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Virtual Address (48-bit):                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚ Sign â”‚ PML4  â”‚ PDPT  â”‚  PD   â”‚  PT   â”‚       Offset           â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ Ext  â”‚ [9]   â”‚ [9]   â”‚ [9]   â”‚ [9]   â”‚        [12]            â”‚  â”‚ â”‚
â”‚  â”‚ â”‚63-48 â”‚47-39  â”‚38-30  â”‚29-21  â”‚20-12  â”‚        11-0            â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Page Sizes: 4KB (PT), 2MB (PD), 1GB (PDPT)                         â”‚ â”‚
â”‚  â”‚ Virtual Space: 256 TiB (48-bit canonical)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  5-Level Paging (LA57):                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Virtual Address (57-bit):                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚ Sign â”‚ PML5  â”‚ PML4  â”‚ PDPT  â”‚  PD   â”‚  PT   â”‚    Offset      â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ Ext  â”‚ [9]   â”‚ [9]   â”‚ [9]   â”‚ [9]   â”‚ [9]   â”‚     [12]       â”‚  â”‚ â”‚
â”‚  â”‚ â”‚63-57 â”‚56-48  â”‚47-39  â”‚38-30  â”‚29-21  â”‚20-12  â”‚     11-0       â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Virtual Space: 128 PiB (57-bit canonical)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  Page Table Entry Flags:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Bit â”‚ Flag                                                         â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  0  â”‚ Present (P)                                                  â”‚ â”‚
â”‚  â”‚  1  â”‚ Read/Write (R/W)                                             â”‚ â”‚
â”‚  â”‚  2  â”‚ User/Supervisor (U/S)                                        â”‚ â”‚
â”‚  â”‚  3  â”‚ Page-level Write-Through (PWT)                               â”‚ â”‚
â”‚  â”‚  4  â”‚ Page-level Cache Disable (PCD)                               â”‚ â”‚
â”‚  â”‚  5  â”‚ Accessed (A)                                                 â”‚ â”‚
â”‚  â”‚  6  â”‚ Dirty (D) - leaf only                                        â”‚ â”‚
â”‚  â”‚  7  â”‚ Page Size (PS) or PAT (leaf)                                 â”‚ â”‚
â”‚  â”‚  8  â”‚ Global (G) - leaf only                                       â”‚ â”‚
â”‚  â”‚ 9-11â”‚ Available for OS                                             â”‚ â”‚
â”‚  â”‚ 12+ â”‚ Physical Address (aligned to page size)                      â”‚ â”‚
â”‚  â”‚ 52-58â”‚ Available for OS (Protection Key in some modes)             â”‚ â”‚
â”‚  â”‚ 59-62â”‚ Available for OS                                            â”‚ â”‚
â”‚  â”‚ 63  â”‚ Execute Disable (XD/NX)                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. APIC Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            APIC FRAMEWORK                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Local APIC (Per-CPU):                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Base Address: IA32_APIC_BASE MSR (usually 0xFEE00000)              â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Registers:                                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚ Offset   â”‚ Register                                            â”‚  â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚ â”‚ 0x020    â”‚ Local APIC ID                                       â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x030    â”‚ Local APIC Version                                  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x080    â”‚ Task Priority Register (TPR)                        â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x090    â”‚ Arbitration Priority Register (APR)                 â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x0A0    â”‚ Processor Priority Register (PPR)                   â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x0B0    â”‚ EOI Register                                        â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x0D0    â”‚ Logical Destination Register (LDR)                  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x0E0    â”‚ Destination Format Register (DFR)                   â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x0F0    â”‚ Spurious Interrupt Vector Register                  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x100-170â”‚ In-Service Registers (ISR)                          â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x180-1F0â”‚ Trigger Mode Registers (TMR)                        â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x200-270â”‚ Interrupt Request Registers (IRR)                   â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x280    â”‚ Error Status Register (ESR)                         â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x300    â”‚ Interrupt Command Register Low (ICR)                â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x310    â”‚ Interrupt Command Register High                     â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x320    â”‚ LVT Timer                                           â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x330    â”‚ LVT Thermal Sensor                                  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x340    â”‚ LVT Performance Counter                             â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x350    â”‚ LVT LINT0                                           â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x360    â”‚ LVT LINT1                                           â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x370    â”‚ LVT Error                                           â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x380    â”‚ Initial Count Register                              â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x390    â”‚ Current Count Register                              â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x3E0    â”‚ Divide Configuration Register                       â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  I/O APIC:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Base Address: Usually 0xFEC00000 (from MADT)                       â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ Registers (indirect access via IOREGSEL/IOWIN):                    â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚ Index    â”‚ Register                                            â”‚  â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚ â”‚ 0x00     â”‚ IOAPIC ID                                           â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x01     â”‚ IOAPIC Version (includes max redirection entries)   â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x02     â”‚ IOAPIC Arbitration ID                               â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x10+2n  â”‚ Redirection Entry n (64-bit, low)                   â”‚  â”‚ â”‚
â”‚  â”‚ â”‚ 0x11+2n  â”‚ Redirection Entry n (64-bit, high)                  â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. Timer Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            TIMER FRAMEWORK                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Timer Sources (by priority order):                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  1. TSC (Time Stamp Counter)                                        â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ Invariant TSC (preferred)                                     â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ Nonstop TSC (C-states)                                      â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ RDTSCP (processor ID)                                       â”‚â”‚
â”‚  â”‚     â””â”€â”€ Calibration via CPUID.15H or PIT/HPET                       â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  2. HPET (High Precision Event Timer)                               â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ 10 MHz+ (100ns resolution)                                  â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ Up to 32 comparators                                        â”‚â”‚
â”‚  â”‚     â””â”€â”€ ACPI table: HPET                                            â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  3. APIC Timer                                                      â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ One-shot mode                                               â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ Periodic mode                                               â”‚â”‚
â”‚  â”‚     â”œâ”€â”€ TSC-deadline mode (modern CPUs)                             â”‚â”‚
â”‚  â”‚     â””â”€â”€ Per-CPU (no contention)                                     â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  4. PIT (Legacy - calibration only)                                 â”‚â”‚
â”‚  â”‚     â””â”€â”€ 1.193182 MHz (fixed frequency)                              â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  Calibration Sequence:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  1. Try CPUID.15H (native TSC frequency)                            â”‚â”‚
â”‚  â”‚  2. Try CPUID.16H (processor base frequency)                        â”‚â”‚
â”‚  â”‚  3. Try MSR_PLATFORM_INFO (on Intel)                                â”‚â”‚
â”‚  â”‚  4. Calibrate using HPET (if available)                             â”‚â”‚
â”‚  â”‚  5. Calibrate using PIT (fallback)                                  â”‚â”‚
â”‚  â”‚  6. Cross-validate TSC vs APIC timer                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  Unified Time API:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  time::now_ns() -> u64           // Nanoseconds since boot          â”‚â”‚
â”‚  â”‚  time::now_tsc() -> u64          // Raw TSC value                   â”‚â”‚
â”‚  â”‚  time::tsc_to_ns(tsc) -> u64     // Convert TSC to ns               â”‚â”‚
â”‚  â”‚  time::delay_ns(ns)              // Busy-wait delay                 â”‚â”‚
â”‚  â”‚  time::set_timer(ns, callback)   // One-shot timer                  â”‚â”‚
â”‚  â”‚  time::set_periodic(ns, callback)// Periodic timer                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7. SMP Framework

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             SMP FRAMEWORK                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  AP Boot Sequence:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  BSP (Bootstrap Processor):                                         â”‚â”‚
â”‚  â”‚  1. Parse MADT for AP APIC IDs                                      â”‚â”‚
â”‚  â”‚  2. Allocate AP stacks (per-CPU)                                    â”‚â”‚
â”‚  â”‚  3. Copy trampoline to 0x8000 (real mode address)                   â”‚â”‚
â”‚  â”‚  4. For each AP:                                                    â”‚â”‚
â”‚  â”‚     a. Send INIT IPI                                                â”‚â”‚
â”‚  â”‚     b. Wait 10ms                                                    â”‚â”‚
â”‚  â”‚     c. Send SIPI (Startup IPI) to 0x8000                            â”‚â”‚
â”‚  â”‚     d. Wait for AP to signal ready                                  â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  AP (Application Processor):                                        â”‚â”‚
â”‚  â”‚  1. Start in real mode at trampoline                                â”‚â”‚
â”‚  â”‚  2. Switch to protected mode                                        â”‚â”‚
â”‚  â”‚  3. Switch to long mode                                             â”‚â”‚
â”‚  â”‚  4. Load per-CPU GDT/IDT                                            â”‚â”‚
â”‚  â”‚  5. Initialize local APIC                                           â”‚â”‚
â”‚  â”‚  6. Signal ready to BSP                                             â”‚â”‚
â”‚  â”‚  7. Wait for work                                                   â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  Per-CPU Data:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  #[repr(C)]                                                         â”‚â”‚
â”‚  â”‚  pub struct PerCpuData {                                            â”‚â”‚
â”‚  â”‚      // Self-pointer for fast access                                â”‚â”‚
â”‚  â”‚      self_ptr: *const PerCpuData,                                   â”‚â”‚
â”‚  â”‚      // CPU identification                                          â”‚â”‚
â”‚  â”‚      cpu_id: u32,                                                   â”‚â”‚
â”‚  â”‚      apic_id: u32,                                                  â”‚â”‚
â”‚  â”‚      // Current execution context                                   â”‚â”‚
â”‚  â”‚      current_task: *mut Task,                                       â”‚â”‚
â”‚  â”‚      kernel_stack: u64,                                             â”‚â”‚
â”‚  â”‚      user_stack: u64,                                               â”‚â”‚
â”‚  â”‚      // TSS for this CPU                                            â”‚â”‚
â”‚  â”‚      tss: *mut TaskStateSegment,                                    â”‚â”‚
â”‚  â”‚      // Local APIC                                                  â”‚â”‚
â”‚  â”‚      apic_base: u64,                                                â”‚â”‚
â”‚  â”‚      // Scheduler state                                             â”‚â”‚
â”‚  â”‚      scheduler: *mut Scheduler,                                     â”‚â”‚
â”‚  â”‚      // Statistics                                                  â”‚â”‚
â”‚  â”‚      irq_count: u64,                                                â”‚â”‚
â”‚  â”‚      context_switches: u64,                                         â”‚â”‚
â”‚  â”‚      // Scratch space                                               â”‚â”‚
â”‚  â”‚      scratch: [u64; 16],                                            â”‚â”‚
â”‚  â”‚  }                                                                  â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  // Access via GS segment (KERNEL_GS_BASE MSR)                      â”‚â”‚
â”‚  â”‚  pub fn current_cpu() -> &'static PerCpuData {                      â”‚â”‚
â”‚  â”‚      unsafe { &*read_gs_offset::<*const PerCpuData>(0) }            â”‚â”‚
â”‚  â”‚  }                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  IPI Types:                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  â€¢ RESCHEDULE: Notify CPU to reschedule                             â”‚â”‚
â”‚  â”‚  â€¢ TLB_SHOOTDOWN: Invalidate TLB entries                            â”‚â”‚
â”‚  â”‚  â€¢ CALL_FUNCTION: Execute function on remote CPU                    â”‚â”‚
â”‚  â”‚  â€¢ CALL_FUNCTION_SINGLE: Execute on specific CPU                    â”‚â”‚
â”‚  â”‚  â€¢ STOP: Stop CPU (for reboot/shutdown)                             â”‚â”‚
â”‚  â”‚  â€¢ NMI: Non-maskable interrupt (debugging)                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”§ Key Interfaces

### CPU Abstraction

```rust
/// CPU capabilities detected at runtime
pub struct CpuCapabilities {
    // Basic features
    pub sse: bool,
    pub sse2: bool,
    pub sse3: bool,
    pub ssse3: bool,
    pub sse4_1: bool,
    pub sse4_2: bool,
    pub avx: bool,
    pub avx2: bool,
    pub avx512f: bool,

    // Security features
    pub smep: bool,           // Supervisor Mode Execution Prevention
    pub smap: bool,           // Supervisor Mode Access Prevention
    pub umip: bool,           // User-Mode Instruction Prevention
    pub pku: bool,            // Protection Keys for Userspace

    // Virtualization
    pub vmx: bool,            // Intel VT-x
    pub svm: bool,            // AMD-V

    // Memory
    pub la57: bool,           // 5-level paging
    pub nx: bool,             // No-Execute
    pub pcid: bool,           // Process-Context Identifiers
    pub invpcid: bool,        // INVPCID instruction

    // APIC
    pub x2apic: bool,
    pub tsc_deadline: bool,

    // Time
    pub invariant_tsc: bool,
    pub tsc_adjust: bool,
    pub rdtscp: bool,

    // Random
    pub rdrand: bool,
    pub rdseed: bool,

    // Power
    pub monitor_mwait: bool,
}
```

### Page Table Abstraction

```rust
/// Page table interface (polymorphic over 4/5 level)
pub trait PageTable: Send + Sync {
    /// Map a virtual address to a physical address
    fn map(
        &mut self,
        virt: VirtAddr,
        phys: PhysAddr,
        size: PageSize,
        flags: PageFlags,
    ) -> Result<(), PagingError>;

    /// Unmap a virtual address
    fn unmap(&mut self, virt: VirtAddr, size: PageSize) -> Result<PhysAddr, PagingError>;

    /// Translate virtual to physical
    fn translate(&self, virt: VirtAddr) -> Option<PhysAddr>;

    /// Update flags for a mapping
    fn update_flags(&mut self, virt: VirtAddr, flags: PageFlags) -> Result<(), PagingError>;

    /// Flush TLB for an address
    fn flush(&self, virt: VirtAddr);

    /// Flush entire TLB
    fn flush_all(&self);

    /// Get the physical address of the root table
    fn root_phys(&self) -> PhysAddr;
}

/// Page sizes supported
pub enum PageSize {
    Kib4,    // 4 KiB
    Mib2,    // 2 MiB
    Gib1,    // 1 GiB
}

/// Page flags
bitflags! {
    pub struct PageFlags: u64 {
        const PRESENT = 1 << 0;
        const WRITABLE = 1 << 1;
        const USER = 1 << 2;
        const WRITE_THROUGH = 1 << 3;
        const NO_CACHE = 1 << 4;
        const ACCESSED = 1 << 5;
        const DIRTY = 1 << 6;
        const HUGE = 1 << 7;
        const GLOBAL = 1 << 8;
        const NO_EXECUTE = 1 << 63;

        // Common combinations
        const KERNEL_RO = Self::PRESENT.bits();
        const KERNEL_RW = Self::PRESENT.bits() | Self::WRITABLE.bits();
        const KERNEL_CODE = Self::PRESENT.bits();
        const KERNEL_DATA = Self::PRESENT.bits() | Self::WRITABLE.bits() | Self::NO_EXECUTE.bits();
        const USER_RO = Self::PRESENT.bits() | Self::USER.bits();
        const USER_RW = Self::PRESENT.bits() | Self::USER.bits() | Self::WRITABLE.bits();
        const USER_CODE = Self::PRESENT.bits() | Self::USER.bits();
        const USER_DATA = Self::PRESENT.bits() | Self::USER.bits() | Self::WRITABLE.bits() | Self::NO_EXECUTE.bits();
    }
}
```

### APIC Abstraction

```rust
/// Local APIC interface
pub trait LocalApic: Send + Sync {
    /// Get APIC ID
    fn id(&self) -> u32;

    /// Get APIC version
    fn version(&self) -> u32;

    /// Enable the local APIC
    fn enable(&mut self);

    /// Send End Of Interrupt
    fn eoi(&self);

    /// Set spurious interrupt vector
    fn set_spurious_vector(&mut self, vector: u8);

    /// Configure timer
    fn set_timer(&mut self, config: TimerConfig);

    /// Start timer in one-shot mode
    fn timer_oneshot(&mut self, ticks: u32);

    /// Start timer in periodic mode
    fn timer_periodic(&mut self, ticks: u32);

    /// Stop timer
    fn timer_stop(&mut self);

    /// Send IPI to another CPU
    fn send_ipi(&self, dest: IpiDestination, vector: u8);

    /// Send INIT IPI
    fn send_init(&self, dest: IpiDestination);

    /// Send SIPI (Startup IPI)
    fn send_sipi(&self, dest: IpiDestination, vector: u8);
}

/// IOAPIC interface
pub trait IoApic: Send + Sync {
    /// Get IOAPIC ID
    fn id(&self) -> u8;

    /// Get maximum redirection entry
    fn max_entry(&self) -> u8;

    /// Configure a redirection entry
    fn set_entry(&mut self, index: u8, entry: RedirectionEntry);

    /// Get a redirection entry
    fn get_entry(&self, index: u8) -> RedirectionEntry;

    /// Mask an IRQ
    fn mask(&mut self, irq: u8);

    /// Unmask an IRQ
    fn unmask(&mut self, irq: u8);
}
```

---

## ðŸ“Š Metrics & Objectives

| Component | Estimated Lines | Complexity | Priority |
|-----------|-----------------|------------|----------|
| Core CPU | 5,000 | High | P0 |
| Segmentation | 3,000 | Medium | P0 |
| Interrupts | 8,000 | Very high | P0 |
| APIC | 6,000 | High | P1 |
| Paging | 10,000 | Very high | P0 |
| Timers | 4,000 | High | P1 |
| SMP | 5,000 | Very high | P1 |
| Syscall | 2,000 | Medium | P1 |
| Context | 3,000 | High | P0 |
| Debug | 2,000 | Medium | P2 |
| ASM | 2,000 | High | P0 |
| **Total** | **50,000+** | - | - |

---

## ðŸ›£ï¸ Implementation Roadmap

### Phase 1: Core Foundation (Week 1-2)
- [ ] Reorganize the directory structure
- [ ] Implement the complete MSR framework
- [ ] Advanced CPUID enumeration
- [ ] Control registers abstraction

### Phase 2: Segmentation & Interrupts (Week 3-4)
- [ ] Per-CPU GDT with multi-TSS
- [ ] IDT framework with automatic generation
- [ ] Complete IST
- [ ] Exception handlers

### Phase 3: Paging (Week 5-6)
- [ ] Complete 4-level paging
- [ ] 5-level paging (LA57)
- [ ] Page mapper/walker
- [ ] TLB management
- [ ] Huge pages

### Phase 4: APIC & Timers (Week 7-8)
- [ ] Local APIC (xAPIC + x2APIC)
- [ ] IOAPIC
- [ ] TSC calibration
- [ ] HPET driver
- [ ] APIC timer

### Phase 5: SMP (Week 9-10)
- [ ] AP boot sequence
- [ ] Real-mode trampoline
- [ ] Per-CPU data
- [ ] IPI support

---

## ðŸ”’ Security Considerations

| Feature | Description | Status |
|---------|-------------|--------|
| SMEP | Prevent kernel exec of user pages | Planned |
| SMAP | Prevent kernel access to user pages | Planned |
| UMIP | Hide privileged info from userspace | Planned |
| KPTI | Kernel Page Table Isolation | Planned |
| KASLR | Kernel Address Randomization | âœ… Done |
| NX | Non-executable memory | Planned |
| Stack Canaries | Stack overflow detection | Planned |

---

## ðŸ“š References

- IntelÂ® 64 and IA-32 Architectures Software Developer's Manual
- AMD64 Architecture Programmer's Manual
- ACPI Specification 6.5
- UEFI Specification 2.10
- OSDev Wiki

---

*Document generated by the Helix OS Architecture Team*

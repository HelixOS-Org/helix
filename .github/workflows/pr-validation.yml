# =============================================================================
# Helix OS - Pull Request Validation Workflow
# =============================================================================
# Enhanced validation for pull requests with security focus
# =============================================================================

name: ðŸ” PR Validation

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - edited
  pull_request_review:
    types:
      - submitted

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ===========================================================================
  # ðŸ“‹ PR METADATA VALIDATION
  # ===========================================================================
  pr-validation:
    name: ðŸ“‹ PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ðŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ðŸ“‹ Validate PR Title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check for conventional commit format
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"

          if [[ $PR_TITLE =~ $PATTERN ]]; then
            echo "âœ… PR title follows conventional commit format"
          else
            echo "âš ï¸ PR title should follow conventional commit format:"
            echo "   feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert(scope): description"
            echo ""
            echo "   Examples:"
            echo "   - feat(hal): add new timer support"
            echo "   - fix(memory): resolve page fault issue"
            echo "   - docs: update README"
          fi

      - name: ðŸ“‹ Check PR Size
        run: |
          ADDITIONS=${{ github.event.pull_request.additions }}
          DELETIONS=${{ github.event.pull_request.deletions }}
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "ðŸ“Š PR Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- Additions: +$ADDITIONS" >> $GITHUB_STEP_SUMMARY
          echo "- Deletions: -$DELETIONS" >> $GITHUB_STEP_SUMMARY
          echo "- Total changes: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL -gt 1000 ]; then
            echo "âš ï¸ **Large PR detected!** Consider splitting into smaller PRs." >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL -gt 500 ]; then
            echo "ðŸ“ Medium-sized PR. Review carefully." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… PR size is manageable." >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # ðŸ”’ SECURITY-SENSITIVE FILE CHECK
  # ===========================================================================
  sensitive-files:
    name: ðŸ”’ Sensitive Files Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ðŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ” Check for Sensitive Files
        run: |
          echo "## ðŸ”’ Sensitive File Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get list of changed files
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          SENSITIVE_PATTERNS=(
            "\.env"
            "\.pem$"
            "\.key$"
            "\.p12$"
            "\.pfx$"
            "credentials"
            "secret"
            "password"
            "token"
            "\.github/workflows"
            "Cargo\.toml$"
            "deny\.toml$"
            "rust-toolchain"
          )

          SECURITY_CRITICAL=false

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if grep -qE "$pattern" changed_files.txt; then
              echo "âš ï¸ Changes detected in sensitive files matching: \`$pattern\`" >> $GITHUB_STEP_SUMMARY
              grep -E "$pattern" changed_files.txt | while read -r file; do
                echo "  - \`$file\`" >> $GITHUB_STEP_SUMMARY
              done
              SECURITY_CRITICAL=true
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SECURITY_CRITICAL" = true ]; then
            echo "ðŸ” **Security review recommended** for this PR." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No sensitive file patterns detected." >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # ðŸ“ CHANGELOG ENTRY CHECK
  # ===========================================================================
  changelog-check:
    name: ðŸ“ Changelog Check
    runs-on: ubuntu-latest
    if: |
      github.base_ref == 'main' ||
      github.base_ref == 'develop' ||
      startsWith(github.base_ref, 'release/')
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ“ Check for Changelog Update
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -qE "^CHANGELOG|^docs/"; then
            echo "âœ… Documentation/changelog updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ Consider adding changelog entry or documentation update" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # ðŸ§ª TEST COVERAGE CHECK
  # ===========================================================================
  coverage-check:
    name: ðŸ§ª Coverage Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: ðŸ§ª Check Test Files
        run: |
          echo "## ðŸ§ª Test Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count test files
          TEST_FILES=$(find . -name "*_test.rs" -o -name "test_*.rs" -o -path "*/tests/*.rs" | wc -l)
          echo "ðŸ“Š Test files found: $TEST_FILES" >> $GITHUB_STEP_SUMMARY

          # Check for #[test] annotations
          TEST_FUNCTIONS=$(grep -r "#\[test\]" --include="*.rs" | wc -l)
          echo "ðŸ“Š Test functions found: $TEST_FUNCTIONS" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # âœ… PR VALIDATION SUMMARY
  # ===========================================================================
  pr-summary:
    name: âœ… PR Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, sensitive-files]
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸ“‹ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Validation | ${{ needs.pr-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sensitive Files | ${{ needs.sensitive-files.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY

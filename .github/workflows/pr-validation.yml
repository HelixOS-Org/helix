# =============================================================================
# Helix OS - Pull Request Validation Workflow
# =============================================================================
# This workflow runs on pull requests to ensure code quality before merge.
# Combined with branch protection rules, it requires approval before merging.
# =============================================================================

name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  pull_request_review:
    types: [submitted]

jobs:
  # ===========================================================================
  # PR Metadata Check
  # ===========================================================================
  pr-check:
    name: üìã PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check for conventional commit format (optional)
          if [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: ]]; then
            echo "‚úÖ PR title follows conventional commit format"
          else
            echo "‚ö†Ô∏è Consider using conventional commit format:"
            echo "   feat: new feature"
            echo "   fix: bug fix"
            echo "   docs: documentation"
            echo "   refactor: code refactoring"
            echo "   test: adding tests"
            echo "   chore: maintenance"
          fi

      - name: Check PR description
        run: |
          BODY_LENGTH=$(echo "${{ github.event.pull_request.body }}" | wc -c)
          if [[ $BODY_LENGTH -lt 20 ]]; then
            echo "‚ö†Ô∏è PR description is very short. Please add more details."
          else
            echo "‚úÖ PR has a description"
          fi

      - name: Check for WIP
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" =~ ^(WIP|wip|\[WIP\]|\[wip\]) ]]; then
            echo "‚ùå This PR is marked as Work In Progress"
            echo "Remove WIP from title when ready for review"
            exit 1
          fi
          echo "‚úÖ PR is not marked as WIP"

  # ===========================================================================
  # Code Changes Analysis
  # ===========================================================================
  changes:
    name: üìä Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - '**/Cargo.lock'
            docs:
              - '**/*.md'
              - 'docs/**'
            ci:
              - '.github/**'

      - name: Report changes
        run: |
          echo "Changes detected:"
          echo "  - Rust code: ${{ steps.filter.outputs.rust }}"
          echo "  - Documentation: ${{ steps.filter.outputs.docs }}"
          echo "  - CI/CD: ${{ steps.filter.outputs.ci }}"

  # ===========================================================================
  # Commit History Check
  # ===========================================================================
  commits:
    name: üìú Commit Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "Checking commit messages..."

          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")

          while IFS= read -r commit; do
            echo "  - $commit"

            # Check for fixup/squash commits
            if [[ "$commit" =~ ^(fixup!|squash!) ]]; then
              echo "    ‚ö†Ô∏è Found fixup/squash commit - please squash before merge"
            fi

            # Check commit length
            if [[ ${#commit} -gt 72 ]]; then
              echo "    ‚ö†Ô∏è Commit message exceeds 72 characters"
            fi
          done <<< "$COMMITS"

          echo ""
          echo "‚úÖ Commit check completed"

  # ===========================================================================
  # Size Check
  # ===========================================================================
  size-check:
    name: üìè Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # Get diff stats
          STATS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD)
          echo "Changes: $STATS"

          # Extract numbers
          INSERTIONS=$(echo "$STATS" | grep -oP '\d+(?= insertion)' || echo "0")
          DELETIONS=$(echo "$STATS" | grep -oP '\d+(?= deletion)' || echo "0")
          TOTAL=$((INSERTIONS + DELETIONS))

          echo ""
          echo "Total lines changed: $TOTAL"

          if [[ $TOTAL -gt 1000 ]]; then
            echo "‚ö†Ô∏è Large PR detected (>1000 lines). Consider splitting into smaller PRs."
          elif [[ $TOTAL -gt 500 ]]; then
            echo "‚ÑπÔ∏è Medium-sized PR (>500 lines)"
          else
            echo "‚úÖ PR size is manageable"
          fi

  # ===========================================================================
  # Label Check
  # ===========================================================================
  labels:
    name: üè∑Ô∏è Labels
    runs-on: ubuntu-latest
    steps:
      - name: Check labels
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          echo "Labels: $LABELS"

          if [[ "$LABELS" == "[]" ]]; then
            echo "‚ÑπÔ∏è No labels assigned. Consider adding labels for categorization."
          else
            echo "‚úÖ PR has labels"
          fi

  # ===========================================================================
  # PR Ready for Review
  # ===========================================================================
  ready:
    name: ‚úÖ Ready for Review
    runs-on: ubuntu-latest
    needs: [pr-check, changes, commits, size-check]
    steps:
      - name: Summary
        run: |
          echo "========================================"
          echo "       PR Validation Complete          "
          echo "========================================"
          echo ""
          echo "This PR is ready for review."
          echo ""
          echo "Reviewers should check:"
          echo "  ‚òê Code quality and style"
          echo "  ‚òê Test coverage"
          echo "  ‚òê Documentation updates"
          echo "  ‚òê Breaking changes"
          echo "  ‚òê Security implications"
          echo ""
          echo "Once approved, the PR can be merged."

# =============================================================================
# Helix OS - Security Scanning Workflow
# =============================================================================
# Runs scheduled security scans and on security-related events
# =============================================================================

name: ðŸ”’ Security Scan

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
      - develop
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'deny.toml'
  pull_request:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'deny.toml'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ===========================================================================
  # ðŸ” VULNERABILITY SCAN
  # ===========================================================================
  vulnerability-scan:
    name: ðŸ” Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ðŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: true

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“¦ Install Security Tools
        run: |
          cargo install cargo-audit --locked
          cargo install cargo-deny --locked --version "~0.18"
          cargo install cargo-outdated --locked

      - name: ðŸ” Cargo Audit
        run: |
          echo "## ðŸ” Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cargo audit --json > audit-report.json 2>&1 || true
          cargo audit 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true

      - name: ðŸ” Cargo Deny
        run: |
          echo "## ðŸš« Dependency Policy Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cargo deny check 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true

      - name: ðŸ“Š Check Outdated Dependencies
        run: |
          echo "## ðŸ“¦ Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cargo outdated --root-deps-only 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true

      - name: ðŸ“¤ Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-${{ github.sha }}
          path: audit-report.json
          retention-days: 30

  # ===========================================================================
  # ðŸ•µï¸ SECRET SCANNING
  # ===========================================================================
  secret-scan:
    name: ðŸ•µï¸ Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ðŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ•µï¸ TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --json
        continue-on-error: true

      - name: ðŸ” Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ===========================================================================
  # ðŸ”’ SBOM GENERATION
  # ===========================================================================
  sbom:
    name: ðŸ”’ Generate SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“¦ Install cargo-sbom
        run: cargo install cargo-sbom --locked
        continue-on-error: true

      - name: ðŸ“‹ Generate SBOM
        run: cargo sbom > sbom.json 2>/dev/null || echo '{"note": "SBOM generation not available"}' > sbom.json
        continue-on-error: true

      - name: ðŸ“¤ Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: sbom.json
          retention-days: 90

  # ===========================================================================
  # ðŸ“Š SECURITY SUMMARY
  # ===========================================================================
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, secret-scan, sbom]
    if: always()
    permissions:
      contents: read
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerability Scan | ${{ needs.vulnerability-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
